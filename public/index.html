<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Currency Converter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0066cc;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-white min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-blue-600 text-white py-4 px-6">
        <h1 class="text-2xl font-semibold">Currency Convert and Save</h1>
    </header>

    <!-- Main Content -->
    <main class="flex-1 px-6 py-6">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 max-w-7xl mx-auto">
            <!-- Left Side - Converter and Countries -->
            <div class="space-y-6">
                <!-- Converter -->
                <div class="bg-white border border-gray-300 rounded-lg">
                    <div class="bg-gray-100 border-b border-gray-300 px-4 py-3">
                        <h2 class="font-semibold text-gray-800" id="formTitle">Currency Converter</h2>
                    </div>
                    <div class="p-6">
                        <form id="conversionForm">
                        <input type="hidden" id="editId" value="">
                        
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">From Currency</label>
                                <input type="text" id="fromCurrency" list="currencyList" 
                                       class="w-full px-3 py-2 border border-gray-400 rounded focus:outline-none focus:border-blue-600"
                                       placeholder="USD" required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">To Currency</label>
                                <input type="text" id="toCurrency" list="currencyList"
                                       class="w-full px-3 py-2 border border-gray-400 rounded focus:outline-none focus:border-blue-600"
                                       placeholder="EUR" required>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Amount</label>
                            <input type="number" id="amount" step="0.01"
                                   class="w-full px-3 py-2 border border-gray-400 rounded focus:outline-none focus:border-blue-600"
                                   placeholder="100" required>
                        </div>
                        
                        <datalist id="currencyList"></datalist>
                        
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Result</label>
                            <div class="w-full px-3 py-4 border border-gray-400 rounded bg-gray-50">
                                <span id="result" class="text-xl font-semibold text-gray-800">--</span>
                                <span id="convertLoader" class="loader ml-2 hidden"></span>
                            </div>
                        </div>
                        
                        <div class="flex gap-3">
                            <button type="button" id="convertBtn" 
                                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded">
                                Convert
                            </button>
                            <button type="submit" 
                                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded">
                                Save
                            </button>
                            <button type="button" id="cancelBtn" 
                                    class="bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded hidden">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Countries using the Currencies - Split View -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- From Currency Countries -->
                <div id="fromCountriesSection" class="bg-white border border-gray-300 rounded-lg hidden">
                    <div class="bg-gray-100 border-b border-gray-300 px-4 py-3 flex justify-between items-center">
                        <h2 class="font-semibold text-gray-800">From: <span id="fromSelectedCurrency" class="text-blue-600"></span></h2>
                        <span id="fromCountriesLoader" class="loader hidden"></span>
                    </div>
                    <div class="p-4 overflow-y-auto" style="max-height: 400px;">
                        <div id="fromCountriesList" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <!-- Countries will be dynamically inserted here -->
                        </div>
                    </div>
                </div>

                <!-- To Currency Countries -->
                <div id="toCountriesSection" class="bg-white border border-gray-300 rounded-lg hidden">
                    <div class="bg-gray-100 border-b border-gray-300 px-4 py-3 flex justify-between items-center">
                        <h2 class="font-semibold text-gray-800">To: <span id="toSelectedCurrency" class="text-blue-600"></span></h2>
                        <span id="toCountriesLoader" class="loader hidden"></span>
                    </div>
                    <div class="p-4 overflow-y-auto" style="max-height: 400px;">
                        <div id="toCountriesList" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <!-- Countries will be dynamically inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

            <!-- Right Side - Saved Records -->
            <div class="bg-white border border-gray-300 rounded-lg">
                <div class="bg-gray-100 border-b border-gray-300 px-4 py-3 flex justify-between items-center">
                    <h2 class="font-semibold text-gray-800">Saved Conversions</h2>
                    <span id="recordsLoader" class="loader hidden"></span>
                </div>
                <div class="p-4 overflow-y-auto" style="max-height: 600px;">
                    <div id="recordsList">
                        <!-- Records will be dynamically inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-6 px-6 border-t border-gray-700 mt-8">
        <div class="max-w-7xl mx-auto">
            <div class="text-center">
                <p id="quoteText" class="text-lg italic">Loading quote...</p>
            </div>
        </div>
    </footer>

    <script>
        let currencies = [];
        let currentResult = 0;

        // Load currencies on page load
        async function loadCurrencies() {
            try {
                const response = await fetch('https://2p9nh463r1.execute-api.us-east-1.amazonaws.com/prod/currencies');
                const data = await response.json();
                currencies = data.currencies;
                
                const datalist = document.getElementById('currencyList');
                datalist.innerHTML = currencies.map(curr => `<option value="${curr}">`).join('');
            } catch (error) {
                console.error('Error loading currencies:', error);
            }
        }

        // Fetch and display countries using a currency (for "from" currency)
        async function loadFromCountriesByCurrency(currencyCode) {
            if (!currencyCode || currencyCode.length !== 3) {
                document.getElementById('fromCountriesSection').classList.add('hidden');
                return;
            }

            const loader = document.getElementById('fromCountriesLoader');
            const countriesList = document.getElementById('fromCountriesList');
            const selectedCurrency = document.getElementById('fromSelectedCurrency');
            const section = document.getElementById('fromCountriesSection');
            
            section.classList.remove('hidden');
            loader.classList.remove('hidden');
            selectedCurrency.textContent = currencyCode.toUpperCase();
            countriesList.innerHTML = '<p class="col-span-full text-gray-500 text-center py-4">Loading countries...</p>';
            
            try {
                const response = await fetch(`https://restcountries.com/v3.1/currency/${currencyCode}`);
                
                if (!response.ok) {
                    throw new Error('Currency not found');
                }
                
                const countries = await response.json();
                
                if (countries.length === 0) {
                    countriesList.innerHTML = '<p class="col-span-full text-gray-500 text-center py-4">No countries found</p>';
                    return;
                }
                
                // Sort countries alphabetically
                countries.sort((a, b) => a.name.common.localeCompare(b.name.common));
                
                countriesList.innerHTML = countries.map(country => `
                    <div class="flex flex-col items-center p-3 border border-gray-300 rounded hover:bg-gray-50 transition">
                        <img src="${country.flags.svg}" 
                             alt="${country.name.common} flag" 
                             class="w-16 h-12 object-cover rounded shadow mb-2"
                             onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%2280%22%3E%3Crect fill=%22%23ddd%22 width=%22100%22 height=%2280%22/%3E%3C/svg%3E'">
                        <span class="text-xs text-center font-medium text-gray-700">${country.name.common}</span>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading countries:', error);
                countriesList.innerHTML = '<p class="col-span-full text-gray-500 text-center py-4">No countries found for this currency</p>';
            } finally {
                loader.classList.add('hidden');
            }
        }

        // Fetch and display countries using a currency (for "to" currency)
        async function loadToCountriesByCurrency(currencyCode) {
            if (!currencyCode || currencyCode.length !== 3) {
                document.getElementById('toCountriesSection').classList.add('hidden');
                return;
            }

            const loader = document.getElementById('toCountriesLoader');
            const countriesList = document.getElementById('toCountriesList');
            const selectedCurrency = document.getElementById('toSelectedCurrency');
            const section = document.getElementById('toCountriesSection');
            
            section.classList.remove('hidden');
            loader.classList.remove('hidden');
            selectedCurrency.textContent = currencyCode.toUpperCase();
            countriesList.innerHTML = '<p class="col-span-full text-gray-500 text-center py-4">Loading countries...</p>';
            
            try {
                const response = await fetch(`https://restcountries.com/v3.1/currency/${currencyCode}`);
                
                if (!response.ok) {
                    throw new Error('Currency not found');
                }
                
                const countries = await response.json();
                
                if (countries.length === 0) {
                    countriesList.innerHTML = '<p class="col-span-full text-gray-500 text-center py-4">No countries found</p>';
                    return;
                }
                
                // Sort countries alphabetically
                countries.sort((a, b) => a.name.common.localeCompare(b.name.common));
                
                countriesList.innerHTML = countries.map(country => `
                    <div class="flex flex-col items-center p-3 border border-gray-300 rounded hover:bg-gray-50 transition">
                        <img src="${country.flags.svg}" 
                             alt="${country.name.common} flag" 
                             class="w-16 h-12 object-cover rounded shadow mb-2"
                             onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%2280%22%3E%3Crect fill=%22%23ddd%22 width=%22100%22 height=%2280%22/%3E%3C/svg%3E'">
                        <span class="text-xs text-center font-medium text-gray-700">${country.name.common}</span>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading countries:', error);
                countriesList.innerHTML = '<p class="col-span-full text-gray-500 text-center py-4">No countries found for this currency</p>';
            } finally {
                loader.classList.add('hidden');
            }
        }

        // Debounce function for "from" currency input
        let fromDebounceTimer;
        function handleFromCurrencyInput(event) {
            clearTimeout(fromDebounceTimer);
            const currencyCode = event.target.value.trim().toUpperCase();
            
            // Wait 500ms after user stops typing
            fromDebounceTimer = setTimeout(() => {
                if (currencyCode.length === 3) {
                    loadFromCountriesByCurrency(currencyCode);
                }
            }, 500);
        }

        // Debounce function for "to" currency input
        let toDebounceTimer;
        function handleToCurrencyInput(event) {
            clearTimeout(toDebounceTimer);
            const currencyCode = event.target.value.trim().toUpperCase();
            
            // Wait 500ms after user stops typing
            toDebounceTimer = setTimeout(() => {
                if (currencyCode.length === 3) {
                    loadToCountriesByCurrency(currencyCode);
                }
            }, 500);
        }

        // Convert currency
        async function convertCurrency() {
            const from = document.getElementById('fromCurrency').value.toUpperCase();
            const to = document.getElementById('toCurrency').value.toUpperCase();
            const amount = document.getElementById('amount').value;

            console.log('Converting:', { from, to, amount });
            
            if (!from || !to || !amount) {
                alert('Please fill all fields');
                return;
            }
            
            const loader = document.getElementById('convertLoader');
            const resultEl = document.getElementById('result');
            
            loader.classList.remove('hidden');
            resultEl.textContent = 'Converting...';
            
            try {
                const response = await fetch(`https://2p9nh463r1.execute-api.us-east-1.amazonaws.com/prod/convert?from=${from}&to=${to}&amount=${amount}`);
                const data = await response.json();
                currentResult = data.result;
                resultEl.textContent = `${amount} ${from} = ${data.result} ${to}`;
            } catch (error) {
                console.error('Error converting currency:', error);
                resultEl.textContent = 'Error';
                alert('Error converting currency');
            } finally {
                loader.classList.add('hidden');
            }
        }

        // Load all conversion records
        async function loadRecords() {
            const loader = document.getElementById('recordsLoader');
            loader.classList.remove('hidden');
            
            try {
                const response = await fetch('/api/conversions');
                const records = await response.json();
                
                const recordsList = document.getElementById('recordsList');
                if (records.length === 0) {
                    recordsList.innerHTML = '<p class="text-gray-500 text-center py-4">No saved conversions</p>';
                    return;
                }
                
                recordsList.innerHTML = records.map(record => `
                    <div class="border border-gray-300 rounded mb-3 p-3">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <div class="font-semibold text-gray-800">
                                    ${record.amount} ${record.from} = ${record.result} ${record.to}
                                </div>
                                <div class="text-xs text-gray-600 mt-1">
                                    Created: ${new Date(record.createdAt).toLocaleString()}<br>
                                    Updated: ${new Date(record.updatedAt).toLocaleString()}
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-2 mt-2">
                            <button onclick="editRecord('${record._id}')" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 text-sm rounded">
                                Edit
                            </button>
                            <button onclick="deleteRecord('${record._id}')" 
                                    class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 text-sm rounded">
                                Delete
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading records:', error);
            } finally {
                loader.classList.add('hidden');
            }
        }

        // Save conversion record
        async function saveRecord(event) {
            event.preventDefault();
            
            const editId = document.getElementById('editId').value;
            const data = {
                from: document.getElementById('fromCurrency').value.toUpperCase(),
                to: document.getElementById('toCurrency').value.toUpperCase(),
                amount: parseFloat(document.getElementById('amount').value),
                result: currentResult
            };
            console.log('Saving record:', data);
            if (currentResult === 0) {
                alert('Please convert the currency first');
                return;
            }
            
            const loader = document.getElementById('recordsLoader');
            loader.classList.remove('hidden');
            
            try {
                let response;
                if (editId) {
                    response = await fetch(`/api/conversions/${editId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } else {
                    response = await fetch('/api/conversions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }
                
                if (response.ok) {
                    resetForm();
                    loadRecords();
                }
            } catch (error) {
                console.error('Error saving record:', error);
                alert('Error saving record');
            } finally {
                loader.classList.add('hidden');
            }
        }

        // Edit a record
        async function editRecord(id) {
            try {
                const response = await fetch(`/api/conversions/${id}`);
                const record = await response.json();
                
                document.getElementById('editId').value = record._id;
                document.getElementById('fromCurrency').value = record.from;
                document.getElementById('toCurrency').value = record.to;
                document.getElementById('amount').value = record.amount;
                const rate = (record.result / record.amount).toFixed(4);
                document.getElementById('result').textContent = `1${record.from} = ${rate}${record.to}`;
                currentResult = record.result;
                
                document.getElementById('formTitle').textContent = 'Edit Conversion';
                document.getElementById('cancelBtn').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading record:', error);
            }
        }

        // Delete a record
        async function deleteRecord(id) {
            if (!confirm('Are you sure you want to delete this record?')) {
                return;
            }
            
            const loader = document.getElementById('recordsLoader');
            loader.classList.remove('hidden');
            
            try {
                const response = await fetch(`/api/conversions/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadRecords();
                }
            } catch (error) {
                console.error('Error deleting record:', error);
                alert('Error deleting record');
            } finally {
                loader.classList.add('hidden');
            }
        }

        // Reset form
        function resetForm() {
            document.getElementById('conversionForm').reset();
            document.getElementById('editId').value = '';
            document.getElementById('result').textContent = '--';
            document.getElementById('formTitle').textContent = 'Currency Converter';
            document.getElementById('cancelBtn').classList.add('hidden');
            currentResult = 0;
        }

        // Event listeners
        document.getElementById('convertBtn').addEventListener('click', convertCurrency);
        document.getElementById('conversionForm').addEventListener('submit', saveRecord);
        document.getElementById('cancelBtn').addEventListener('click', resetForm);
        
        // Add currency input listeners for country display
        document.getElementById('fromCurrency').addEventListener('input', handleFromCurrencyInput);
        document.getElementById('toCurrency').addEventListener('input', handleToCurrencyInput);
        
        // Also trigger on focus to show countries for already entered currency
        document.getElementById('fromCurrency').addEventListener('focus', function() {
            const value = this.value.trim().toUpperCase();
            if (value.length === 3) loadFromCountriesByCurrency(value);
        });
        document.getElementById('toCurrency').addEventListener('focus', function() {
            const value = this.value.trim().toUpperCase();
            if (value.length === 3) loadToCountriesByCurrency(value);
        });

        // Load random quote
        async function loadQuote() {
            try {
                const response = await fetch('https://api.quotable.io/random');
                const data = await response.json();
                document.getElementById('quoteText').textContent = `" ${data.content} "`;
            } catch (error) {
                console.error('Error loading quote:', error);
                document.getElementById('quoteText').textContent = 'Unable to load quote';
            }
        }

        // Initialize
        loadCurrencies();
        loadRecords();
        loadQuote();
    </script>
</body>
</html>
